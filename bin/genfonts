#!/usr/bin/env perl
use warnings;
use strict;

our $windows = 0;
our $dryRun = 0;
our $noSave = 0;
our $noTrace = 0;

use Getopt::Long;
Getopt::Long::Configure('bundling', 'getopt_compat', 'no_ignore_case');
Getopt::Long::GetOptions(
    'w|windows' => \$windows,
    'n|dry-run' => \$dryRun,
    'no-save' => \$noSave,
    'no-trace' => \$noTrace,
) or die(":-(");

my $gen = My::FontGenerator->new();
$gen->{specified} = \@ARGV;
$gen->{windows} = $windows;
$gen->{dryRun} = $dryRun;
$gen->generateFonts();

###############################################################################

package My::FontGenerator {
    use warnings;
    use strict;

    use File::Basename qw(basename dirname);
    use File::Path qw(make_path);
    use File::Which qw(which);
    use String::ShellQuote qw(shell_quote);

    our $bitmapfont2ttf;
    BEGIN {
        $bitmapfont2ttf = which('bitmapfont2ttf');
        if (!defined $bitmapfont2ttf) {
            die("bitmapfont2ttf: no executable found\n");
        }
    }

    sub new {
        my ($class) = @_;
        my $self = bless({}, $class);
        return $self;
    }

    sub generateFont {
        my ($self, $subdir, $source, $basename, $familyname, %args) = @_;
        my @variant = @{$args{variants} // []};
        my @tags    = @{$args{tags} // []};
        my $winFixPixelHeight = $args{winFixPixelHeight} // [0, 0];

        my $familynamePrefix = $self->{windows} ? 'XBF WIN ' : 'XBF ';
        $familyname = $familynamePrefix . $familyname;

        my $basenamePrefix = $self->{windows} ? 'XBF-WIN-' : 'XBF-';
        $basename = $basenamePrefix . $basename;

        my $fullname = $familyname;
        if (scalar @variant) {
            $fullname .= ' ' . join(' ', @variant);
        }

        my $fontname = $fullname;
        $fontname =~ s{\s+}{}g;

        our @bitmapfont2ttfOptions = ('--monospace', '--verbosity');
        if ($self->{windows}) {
            if (defined $winFixPixelHeight) {
                push(@bitmapfont2ttfOptions, '--fix-windows-pixel-height');
                push(@bitmapfont2ttfOptions, '--add-ascent',  $winFixPixelHeight->[0]);
                push(@bitmapfont2ttfOptions, '--add-descent', $winFixPixelHeight->[1]);
            }
        }

        push(@bitmapfont2ttfOptions, '--no-save') if $noSave;
        push(@bitmapfont2ttfOptions, '--no-trace') if $noTrace;

        my $ttf;
        my $sfd;
        if ($self->{windows}) {
            $ttf = "fonts/windows/${basename}.ttf";
            $sfd = "sfd/windows/${basename}.sfd";
        } else {
            $ttf = "fonts/macos/${basename}.ttf";
            $sfd = "sfd/macos/${basename}.sfd";
        }

        my @specified = @{$self->{specified} // []};

        if (scalar @specified) {
            return 0 if !tagmatch([@specified], ($subdir, $source, $basename, $familyname, $fullname, $fontname, $ttf, $sfd, @tags));
        }

        my @dependencies = (
            $0,
            $bitmapfont2ttf,
            dirname($bitmapfont2ttf) . '/../lib/mybdf.py',
            dirname($bitmapfont2ttf) . '/../lib/mybdfchar.py',
            dirname($bitmapfont2ttf) . '/../lib/bitmapfont2ttf.py',
        );

        if (isuptodate([$ttf, $sfd], @dependencies)) {
            printf STDERR ("%s%s and %s are up to date%s\n",
                           "\e[0;32m",
                           $sfd,
                           $ttf,
                           "\e[0m");
            return;
        }

        print STDERR ("\e[0;32m") if -t 2;
        printf STDERR ("Generating %s\n", $sfd);
        printf STDERR ("       and %s...\n", $ttf);
        print STDERR ("\e[0m") if -t 2;
        make_path(dirname($ttf));
        make_path(dirname($sfd));
        my @cmd = (
            'bitmapfont2ttf',
            "--font-name=${fontname}",
            "--full-name=${fullname}",
            "--family-name=${familyname}",
            @bitmapfont2ttfOptions,
            $source,
            $ttf,
            $sfd
        );
        if ($self->{dryRun}) {
            print(shell_quote(@cmd), "\n");
        } else {
            system(@cmd) and exit(1);
        }
    }

    sub generateFonts {
        my ($self) = @_;

        #                   subdir,              source,                                        basename,                     familyname,              variants                                                                                                                             add to [descent, ascent] usually [0,0] or [0,1] or [1,1]
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutBS08.bdf', 'Lucida-Typewriter-8H-Bold',   'Lucida Typewriter 8H',   variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutBS10.bdf', 'Lucida-Typewriter-10H-Bold',  'Lucida Typewriter 10H',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutBS12.bdf', 'Lucida-Typewriter-12H-Bold',  'Lucida Typewriter 12H',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutBS14.bdf', 'Lucida-Typewriter-14H-Bold',  'Lucida Typewriter 14H',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutBS18.bdf', 'Lucida-Typewriter-18H-Bold',  'Lucida Typewriter 18H',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutBS19.bdf', 'Lucida-Typewriter-19H-Bold',  'Lucida Typewriter 19H',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutBS24.bdf', 'Lucida-Typewriter-24H-Bold',  'Lucida Typewriter 24H',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [1, 1]);

        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutRS08.bdf', 'Lucida-Typewriter-8H',        'Lucida Typewriter 8H',                         winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutRS10.bdf', 'Lucida-Typewriter-10H',       'Lucida Typewriter 10H',                        winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutRS12.bdf', 'Lucida-Typewriter-12H',       'Lucida Typewriter 12H',                        winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutRS14.bdf', 'Lucida-Typewriter-14H',       'Lucida Typewriter 14H',                        winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutRS18.bdf', 'Lucida-Typewriter-18H',       'Lucida Typewriter 18H',                        winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutRS19.bdf', 'Lucida-Typewriter-19H',       'Lucida Typewriter 19H',                        winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-100dpi/lutRS24.bdf', 'Lucida-Typewriter-24H',       'Lucida Typewriter 24H',                        winPixelHeight => 00, winFixPixelHeight => [1, 1]);

        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutBS08.bdf',  'Lucida-Typewriter-8-Bold',   'Lucida Typewriter 8',   variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutBS10.bdf',  'Lucida-Typewriter-10-Bold',  'Lucida Typewriter 10',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutBS12.bdf',  'Lucida-Typewriter-12-Bold',  'Lucida Typewriter 12',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutBS14.bdf',  'Lucida-Typewriter-14-Bold',  'Lucida Typewriter 14',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutBS18.bdf',  'Lucida-Typewriter-18-Bold',  'Lucida Typewriter 18',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutBS19.bdf',  'Lucida-Typewriter-19-Bold',  'Lucida Typewriter 19',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutBS24.bdf',  'Lucida-Typewriter-24-Bold',  'Lucida Typewriter 24',  variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [1, 1]);

        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutRS08.bdf',  'Lucida-Typewriter-8',        'Lucida Typewriter 8',                         winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutRS10.bdf',  'Lucida-Typewriter-10',       'Lucida Typewriter 10',                        winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutRS12.bdf',  'Lucida-Typewriter-12',       'Lucida Typewriter 12',                        winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutRS14.bdf',  'Lucida-Typewriter-14',       'Lucida Typewriter 14',                        winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutRS18.bdf',  'Lucida-Typewriter-18',       'Lucida Typewriter 18',                        winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutRS19.bdf',  'Lucida-Typewriter-19',       'Lucida Typewriter 19',                        winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('lucida-typewriter', 'xorg-bh-lucidatypewriter-75dpi/lutRS24.bdf',  'Lucida-Typewriter-24',       'Lucida Typewriter 24',                        winPixelHeight => 00, winFixPixelHeight => [0, 1]);

        $self->generateFont('dec-terminal', 'xorg-bitstream-100dpi/term14.bdf',  'DEC-Terminal-18',      'DEC Terminal 18',                       winPixelHeight => 00, winFixPixelHeight => [0, 1]); # FIXME
        $self->generateFont('dec-terminal', 'xorg-bitstream-100dpi/termB14.bdf', 'DEC-Terminal-18-Bold', 'DEC Terminal 18', variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 0]); # FIXME
        $self->generateFont('dec-terminal', 'xorg-bitstream-75dpi/term14.bdf',   'DEC-Terminal-14',      'DEC Terminal 14',                       winPixelHeight => 00, winFixPixelHeight => [0, 1]); # DIFF
        $self->generateFont('dec-terminal', 'xorg-bitstream-75dpi/termB14.bdf',  'DEC-Terminal-14-Bold', 'DEC Terminal 14', variants => ['Bold'], winPixelHeight => 00, winFixPixelHeight => [0, 1]); # DIFF

        $self->generateFont('misc-fixed', 'xorg-misc-misc/10x20.bdf', 'Misc-Fixed-10x20', 'Misc Fixed 10x20',                         tags => ['misc-fixed-10x20'], winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/4x6.bdf',   'Misc-Fixed-4x6',   'Misc Fixed 4x6',                           tags => ['misc-fixed-4x6'],   winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/5x7.bdf',   'Misc-Fixed-5x7',   'Misc Fixed 5x7',                           tags => ['misc-fixed-5x7'],   winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/5x8.bdf',   'Misc-Fixed-5x8',   'Misc Fixed 5x8',                           tags => ['misc-fixed-5x8'],   winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/6x10.bdf',  'Misc-Fixed-6x10',  'Misc Fixed 6x10',                          tags => ['misc-fixed-6x10'],  winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/6x12.bdf',  'Misc-Fixed-6x12',  'Misc Fixed 6x12',                          tags => ['misc-fixed-6x12'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/6x13.bdf',  'Misc-Fixed-6x13',  'Misc Fixed 6x13',                          tags => ['misc-fixed-6x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/6x13B.bdf', 'Misc-Fixed-6x13B', 'Misc Fixed 6x13', variants => ['Bold'],    tags => ['misc-fixed-6x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/6x13O.bdf', 'Misc-Fixed-6x13O', 'Misc Fixed 6x13', variants => ['Oblique'], tags => ['misc-fixed-6x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/6x9.bdf',   'Misc-Fixed-6x9',   'Misc Fixed 6x9',                           tags => ['misc-fixed-6x9'],   winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/7x13.bdf',  'Misc-Fixed-7x13',  'Misc Fixed 7x13',                          tags => ['misc-fixed-7x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/7x13B.bdf', 'Misc-Fixed-7x13B', 'Misc Fixed 7x13', variants => ['Bold'],    tags => ['misc-fixed-7x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/7x13O.bdf', 'Misc-Fixed-7x13O', 'Misc Fixed 7x13', variants => ['Oblique'], tags => ['misc-fixed-7x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/7x14.bdf',  'Misc-Fixed-7x14',  'Misc Fixed 7x14',                          tags => ['misc-fixed-7x14'],  winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/7x14B.bdf', 'Misc-Fixed-7x14B', 'Misc Fixed 7x14', variants => ['Bold'],    tags => ['misc-fixed-7x14'],  winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/8x13.bdf',  'Misc-Fixed-8x13',  'Misc Fixed 8x13',                          tags => ['misc-fixed-8x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/8x13B.bdf', 'Misc-Fixed-8x13B', 'Misc Fixed 8x13', variants => ['Bold'],    tags => ['misc-fixed-8x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/8x13O.bdf', 'Misc-Fixed-8x13O', 'Misc Fixed 8x13', variants => ['Oblique'], tags => ['misc-fixed-8x13'],  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/9x15.bdf',  'Misc-Fixed-9x15',  'Misc Fixed 9x15',                          tags => ['misc-fixed-9x15'],  winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/9x15B.bdf', 'Misc-Fixed-9x15B', 'Misc Fixed 9x15', variants => ['Bold'],    tags => ['misc-fixed-9x15'],  winPixelHeight => 00, winFixPixelHeight => [0, 1]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/9x18.bdf',  'Misc-Fixed-9x18',  'Misc Fixed 9x18',                          tags => ['misc-fixed-9x18'],  winPixelHeight => 00, winFixPixelHeight => [1, 1]);
        $self->generateFont('misc-fixed', 'xorg-misc-misc/9x18B.bdf', 'Misc-Fixed-9x18B', 'Misc Fixed 9x18', variants => ['Bold'],    tags => ['misc-fixed-9x18'],  winPixelHeight => 00, winFixPixelHeight => [1, 1]);

        $self->generateFont('sony-fixed', 'xorg-sony-misc/12x24.bdf', 'Sony-Fixed-12x24', 'Sony Fixed 12x24', winPixelHeight => 00, winFixPixelHeight => [0, 0]);
        $self->generateFont('sony-fixed', 'xorg-sony-misc/8x16.bdf',  'Sony-Fixed-8x16',  'Sony Fixed 8x16',  winPixelHeight => 00, winFixPixelHeight => [0, 0]);
    }

    sub isuptodate {
        my ($target, @dependencies) = @_;
        if (ref $target eq 'ARRAY') {
            foreach my $subtarget (@$target) {
                return 0 if !isuptodate($subtarget, @dependencies);
            }
            return 1;
        }
        return 0 if !-e $target;
        my $targetage = -M $target;
        return 0 if grep { $targetage > -M $_ } @dependencies;
        return 1;
    }

    sub tagmatch {
        my ($specified, @tags) = @_;
        if (ref $specified eq 'ARRAY') {
            return (grep { tagmatch($_, @tags) } @$specified) ? 1 : 0;
        }
        return (grep { $specified eq $_ } @tags) ? 1 : 0;
    }
};
